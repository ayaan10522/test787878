<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gambo Starter</title>

    <script
      async
      data-adbreak-test="on"
      crossorigin="anonymous"
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=pub-3086347538258327"
    ></script>
    <script>
      window.adsbygoogle = window.adsbygoogle || []
      var adBreak = (adConfig = function (o) {
        adsbygoogle.push(o)
      })
      adConfig({ sound: "on", preloadAdBreaks: "on" })
    </script>

    <style>
      body {
        background: black;
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: white;
        overflow: hidden;
      }
      
      #game-container {
        width: 1152px;
        height: 768px;
        margin: auto;
      }

      /* Overlay for UI */
      #ui-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
      }

      .card {
        background: #111;
        border: 1px solid #333;
        border-radius: 20px;
        padding: 2.5rem;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.8);
      }

      .btn {
        width: 100%;
        padding: 0.85rem;
        border-radius: 10px;
        border: none;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-top: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .btn-primary { background: #2563eb; color: white; }
      .btn-primary:hover { background: #1d4ed8; transform: translateY(-2px); }
      .btn-secondary { background: #374151; color: white; }
      .btn-secondary:hover { background: #4b5563; }

      .input-group { margin-bottom: 1.5rem; }
      .input-group label { display: block; margin-bottom: 0.6rem; font-size: 0.9rem; color: #aaa; }
      .input-group input {
        width: 100%;
        padding: 0.85rem;
        background: #222;
        border: 1px solid #444;
        border-radius: 10px;
        color: white;
        outline: none;
        box-sizing: border-box;
      }
      .input-group input:focus { border-color: #2563eb; background: #2a2a2a; }

      .hidden { display: none !important; }

      /* Social Hub */
      #social-hub {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 900;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .social-btn {
        background: rgba(30, 30, 30, 0.9);
        border: 1px solid #444;
        color: white;
        padding: 12px 24px;
        border-radius: 40px;
        backdrop-filter: blur(5px);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        transition: all 0.2s;
      }
      .social-btn:hover { background: #222; border-color: #666; }

      #friends-panel {
        position: fixed;
        top: 85px;
        right: 20px;
        width: 340px;
        height: calc(100% - 130px);
        background: rgba(15, 15, 15, 0.98);
        border: 1px solid #333;
        border-radius: 20px;
        z-index: 850;
        padding: 1.8rem;
        display: flex;
        flex-direction: column;
        box-shadow: -10px 0 40px rgba(0,0,0,0.7);
      }

      .friends-list { flex: 1; overflow-y: auto; margin-top: 1.2rem; }
      .friend-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border-bottom: 1px solid #222;
        transition: background 0.2s;
      }
      .friend-item:hover { background: #1a1a1a; }
      .friend-info { display: flex; flex-direction: column; }
      .friend-name { font-weight: 600; font-size: 1rem; }
      .friend-status { font-size: 0.75rem; color: #10b981; }
      .friend-status.offline { color: #6b7280; }

      .badge {
        background: #ef4444;
        color: white;
        font-size: 0.75rem;
        padding: 3px 8px;
        border-radius: 12px;
        font-weight: 800;
      }

      /* Character Selection */
      .char-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }
      .char-option {
        border: 2px solid #333;
        border-radius: 15px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }
      .char-option:hover { border-color: #2563eb; background: #1a1a1a; }
      .char-option.selected { border-color: #2563eb; background: #1e3a8a; }
      .char-option img { width: 100%; border-radius: 10px; margin-bottom: 10px; }

      /* Lobby UI */
      #lobby-ui {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        z-index: 100;
      }

      .lobby-content {
        text-align: center;
        max-width: 600px;
      }

      .lobby-title {
        font-size: 4rem;
        font-weight: 900;
        margin-bottom: 1rem;
        background: linear-gradient(to right, #3b82f6, #60a5fa);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -2px;
      }

      .lobby-subtitle {
        font-size: 1.25rem;
        color: #94a3b8;
        margin-bottom: 3rem;
      }

      .welcome-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 2rem;
        border-radius: 24px;
        backdrop-filter: blur(10px);
      }
    </style>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBo3Gwptq1cbCqwP_DFQFdV7vgWuOZiQCg",
        authDomain: "ojbn-c0ac5.firebaseapp.com",
        databaseURL: "https://ojbn-c0ac5-default-rtdb.firebaseio.com",
        projectId: "ojbn-c0ac5",
        storageBucket: "ojbn-c0ac5.firebasestorage.app",
        messagingSenderId: "874334079680",
        appId: "1:874334079680:web:5da727d5e3c496bc737b25",
        measurementId: "G-R79NKBX8LY"
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      let currentUser = null;
      let friends = [];
      let requests = [];
      let currentMatch = null;
      let isHost = false;
      let selectedChar = 'messi';
      window.isInputFocused = false;

      // Custom Auth Logic
      async function handleSignUp() {
        const username = document.getElementById('signup-username').value.toLowerCase();
        const pass = document.getElementById('signup-password').value;
        if (!username || !pass) return alert("Please fill all fields");

        const userRef = db.ref('users/' + username);
        const snap = await userRef.get();
        if (snap.exists()) return alert("Username already taken");

        await userRef.set({ username, password: pass, status: 'online', lastActive: Date.now() });
        loginUser(username);
      }

      async function handleLogin() {
        const username = document.getElementById('login-username').value.toLowerCase();
        const pass = document.getElementById('login-password').value;
        
        const userRef = db.ref('users/' + username);
        const snap = await userRef.get();
        if (!snap.exists() || snap.val().password !== pass) return alert("Invalid username or password");

        loginUser(username);
      }

      function loginUser(username) {
        currentUser = { username };
        localStorage.setItem('gambo_user', username);
        document.getElementById('ui-overlay').classList.add('hidden');
        document.getElementById('social-hub').classList.remove('hidden');
        document.getElementById('lobby-ui').classList.remove('hidden');
        document.getElementById('welcome-username').textContent = username;
        listenToSocialUpdates(username);
        listenForChallenges(username);
        
        // Update online status
        db.ref('users/' + username).update({ status: 'online', lastActive: Date.now() });
      }

      function handleLogout() {
        if (currentUser) db.ref('users/' + currentUser.username).update({ status: 'offline' });
        currentUser = null;
        localStorage.removeItem('gambo_user');
        location.reload();
      }

      // Update online status
      function setOnlineStatus(status) {
        if (currentUser) db.ref('users/' + currentUser.username).update({ status });
      }

      window.onbeforeunload = () => setOnlineStatus('offline');
      window.onfocus = () => setOnlineStatus('online');
      window.onblur = () => setOnlineStatus('away');

      // Check for saved session
      window.onload = () => {
        const saved = localStorage.getItem('gambo_user');
        if (saved) loginUser(saved);
        
        // Input focus listeners to prevent game movement
        document.querySelectorAll('input').forEach(input => {
          input.addEventListener('focus', () => window.isInputFocused = true);
          input.addEventListener('blur', () => window.isInputFocused = false);
        });
      };

      function listenForChallenges(username) {
        db.ref('challenges/' + username).on('value', snapshot => {
          const data = snapshot.val();
          if (data) {
            const [challengerId, challenge] = Object.entries(data)[0];
            if (confirm(`${challenge.from} challenged you! Accept?`)) {
              acceptChallenge(challengerId, challenge);
            }
          }
        });
      }

      async function challengeFriend(friendId) {
        // Open char selection first
        document.getElementById('char-select-overlay').classList.remove('hidden');
        window.pendingChallengeId = friendId;
      }

      async function confirmChallenge() {
        const friendId = window.pendingChallengeId;
        document.getElementById('char-select-overlay').classList.add('hidden');
        
        const challengeRef = db.ref('challenges/' + friendId + '/' + currentUser.username);
        await challengeRef.set({
          from: currentUser.username,
          char: selectedChar,
          timestamp: Date.now()
        });
        
        db.ref('matches').orderByChild('host').equalTo(currentUser.username).on('child_added', snap => {
          if (snap.val().guest === friendId) startMatch(snap.key, true, selectedChar, snap.val().guestChar);
        });
      }

      async function acceptChallenge(challengerId, challenge) {
        const matchId = 'match_' + Date.now();
        await db.ref('matches/' + matchId).set({
          host: challengerId,
          guest: currentUser.username,
          hostChar: challenge.char,
          guestChar: selectedChar, // Uses whatever was last selected
          ball: { x: 576, y: 384, vx: 0, vy: 0 },
          p1: { x: 150, y: 648 },
          p2: { x: 1002, y: 648 },
          score: { p1: 0, p2: 0 },
          status: 'playing'
        });
        await db.ref('challenges/' + currentUser.username + '/' + challengerId).remove();
        startMatch(matchId, false, selectedChar, challenge.char);
      }

      function startMatch(matchId, asHost, myChar, otherChar) {
        currentMatch = matchId;
        isHost = asHost;
        document.getElementById('friends-panel').classList.add('hidden');
        document.getElementById('social-hub').classList.add('hidden');
        document.getElementById('lobby-ui').classList.add('hidden');
        
        // Start Phaser Game
        window.startGame({ matchId, isHost, myChar, otherChar });
        
        setInterval(syncGameState, 33);
        db.ref('matches/' + matchId).on('value', snap => {
          const state = snap.val();
          if (state) applyRemoteState(state);
        });
      }

      function syncGameState() {
        if (!currentMatch || !window.currentScene) return;
        const scene = window.currentScene;
        const updates = {};
        if (isHost) {
          updates[`matches/${currentMatch}/p1`] = { x: scene.player1.x, y: scene.player1.y };
          updates[`matches/${currentMatch}/ball`] = { x: scene.ball.x, y: scene.ball.y, vx: scene.ball.body.velocity.x, vy: scene.ball.body.velocity.y };
          updates[`matches/${currentMatch}/score`] = { p1: scene.player1Score, p2: scene.player2Score };
        } else {
          updates[`matches/${currentMatch}/p2`] = { x: scene.player2.x, y: scene.player2.y };
        }
        db.ref().update(updates);
      }

      function applyRemoteState(state) {
        const scene = window.currentScene;
        if (!scene) return;
        if (isHost) {
          scene.player2.x = state.p2.x;
          scene.player2.y = state.p2.y;
        } else {
          scene.player1.x = state.p1.x;
          scene.player1.y = state.p1.y;
          scene.ball.x = state.ball.x;
          scene.ball.y = state.ball.y;
          scene.ball.body.setVelocity(state.ball.vx, state.ball.vy);
          scene.player1Score = state.score.p1;
          scene.player2Score = state.score.p2;
          scene.scoreText.setText(`${state.score.p1} - ${state.score.p2}`);
        }
      }

      // Social Updates
      function listenToSocialUpdates(username) {
        db.ref('requests/' + username).on('value', snap => {
          requests = Object.entries(snap.val() || {}).map(([id, v]) => ({ id, ...v }));
          updateSocialBadges();
          renderRequests();
        });

        db.ref('friends/' + username).on('value', async snap => {
          const ids = Object.keys(snap.val() || {});
          friends = await Promise.all(ids.map(async id => {
            const u = await db.ref('users/' + id).get();
            return { id, ...u.val() };
          }));
          renderFriends();
        });
      }

      function updateSocialBadges() {
        const badge = document.getElementById('req-badge');
        badge.textContent = requests.length;
        badge.classList.toggle('hidden', requests.length === 0);
      }

      async function sendFriendRequest(targetName) {
        targetName = targetName.toLowerCase();
        const snap = await db.ref('users/' + targetName).get();
        if (!snap.exists()) return alert("User not found");
        if (targetName === currentUser.username) return alert("Can't add yourself");
        
        await db.ref('requests/' + targetName + '/' + currentUser.username).set({
          from: currentUser.username,
          timestamp: Date.now()
        });
        alert("Request sent!");
      }

      async function acceptRequest(requestId) {
        const updates = {};
        updates[`friends/${currentUser.username}/${requestId}`] = true;
        updates[`friends/${requestId}/${currentUser.username}`] = true;
        updates[`requests/${currentUser.username}/${requestId}`] = null;
        await db.ref().update(updates);
      }

      function renderFriends() {
        const list = document.getElementById('friends-list-container');
        list.innerHTML = friends.length === 0 ? '<p style="color:#666;text-align:center;">No friends yet</p>' : '';
        friends.forEach(f => {
          const div = document.createElement('div');
          div.className = 'friend-item';
          div.innerHTML = `
            <div class="friend-info">
              <span class="friend-name">${f.username}</span>
              <span class="friend-status ${f.status}">${f.status}</span>
            </div>
            ${f.status === 'online' ? `<button onclick="challengeFriend('${f.id}')" style="background:#10b981;color:white;border:none;padding:8px 15px;border-radius:20px;font-size:0.8rem;cursor:pointer;font-weight:700;">PLAY</button>` : ''}
          `;
          list.appendChild(div);
        });
      }

      function renderRequests() {
        const list = document.getElementById('requests-list-container');
        list.innerHTML = requests.length === 0 ? '<p style="color:#666;text-align:center;">No requests</p>' : '';
        requests.forEach(r => {
          const div = document.createElement('div');
          div.className = 'friend-item';
          div.innerHTML = `<span>${r.from}</span><button onclick="acceptRequest('${r.id}')" style="background:#2563eb;color:white;border:none;padding:5px 12px;border-radius:15px;cursor:pointer;">Accept</button>`;
          list.appendChild(div);
        });
      }
    </script>
    <script type="module" src="/assets/game.js"></script>
  </head>
  <body>
    <div id="game-container"></div>

    <!-- Auth Overlay -->
    <div id="ui-overlay">
      <div id="login-card" class="card">
        <h1 style="text-align:center;margin-bottom:2rem;color:#2563eb;">GAMBO ONLINE</h1>
        <div class="input-group">
          <label>Username</label>
          <input type="text" id="login-username" placeholder="Enter username">
        </div>
        <div class="input-group">
          <label>Password</label>
          <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <button class="btn btn-primary" onclick="handleLogin()">Login</button>
        <p style="text-align:center;margin-top:1.5rem;color:#666;">
          New here? <a href="#" onclick="toggleAuth()" style="color:#2563eb;text-decoration:none;">Create Account</a>
        </p>
      </div>

      <div id="signup-card" class="card hidden">
        <h1 style="text-align:center;margin-bottom:2rem;color:#2563eb;">JOIN GAMBO</h1>
        <div class="input-group">
          <label>Username</label>
          <input type="text" id="signup-username" placeholder="Choose username">
        </div>
        <div class="input-group">
          <label>Password</label>
          <input type="password" id="signup-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <button class="btn btn-primary" onclick="handleSignUp()">Sign Up</button>
        <p style="text-align:center;margin-top:1.5rem;color:#666;">
          Have account? <a href="#" onclick="toggleAuth()" style="color:#2563eb;text-decoration:none;">Login</a>
        </p>
      </div>
    </div>

    <!-- Char Select Overlay -->
    <div id="char-select-overlay" class="ui-overlay hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:1100;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;">
      <div class="card">
        <h2 style="text-align:center;">Choose Your Player</h2>
        <div class="char-grid">
          <div class="char-option" id="char-messi" onclick="selectChar('messi')">
            <img src="https://cdn-game-mcp.gambo.ai/b81f2b2f-0ae0-4d02-b06a-9ffbbf27614b/animations/messi_idle_R/frame_1.png">
            <div>MESSI</div>
          </div>
          <div class="char-option" id="char-ronaldo" onclick="selectChar('ronaldo')">
            <img src="https://cdn-game-mcp.gambo.ai/d515e62f-46fe-4011-85b6-2dce3bc71fe8/animations/ronaldo_idle_R/frame_1.png">
            <div>RONALDO</div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="confirmChallenge()">START MATCH</button>
      </div>
    </div>

    <!-- Lobby UI -->
    <div id="lobby-ui" class="hidden">
      <div class="lobby-content">
        <h1 class="lobby-title">GAMBO ONLINE</h1>
        <p class="lobby-subtitle">Real-time 1v1 Multiplayer Soccer</p>
        
        <div class="welcome-card">
          <h2 style="margin-top:0;">Welcome back, <span id="welcome-username" style="color:#3b82f6;">Player</span>!</h2>
          <p style="color:#94a3b8; line-height:1.6;">
            You are now in the social lobby. Use the <b>Friends</b> button in the top right to:
          </p>
          <ul style="text-align:left; color:#cbd5e1; display:inline-block; margin:1rem 0;">
            <li>Search and add friends by username</li>
            <li>Accept incoming friend requests</li>
            <li>Challenge online friends to 1v1 matches</li>
          </ul>
          <p style="font-size:0.9rem; color:#64748b; margin-top:1rem; border-top:1px solid rgba(255,255,255,0.1); padding-top:1rem;">
            Select your character (Messi or Ronaldo) after challenging a friend!
          </p>
        </div>
      </div>
    </div>

    <div id="social-hub" class="hidden">
      <button class="social-btn" onclick="toggleFriendsPanel()">
        <span>ðŸ‘¥ Friends</span>
        <span id="req-badge" class="badge hidden">0</span>
      </button>
      <button class="social-btn" onclick="handleLogout()">ðŸšª Logout</button>
    </div>

    <div id="friends-panel" class="hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2 style="margin:0;">Social</h2>
        <button onclick="toggleFriendsPanel()" style="background:none;border:none;color:#666;font-size:2rem;cursor:pointer;">&times;</button>
      </div>
      <div style="margin-top:1.5rem;">
        <div class="input-group">
          <input type="text" id="add-friend-name" placeholder="Search username...">
          <button class="btn btn-secondary" style="margin-top:0.5rem;" onclick="sendFriendRequest(document.getElementById('add-friend-name').value)">Add Friend</button>
        </div>
      </div>
      <div style="margin-top:1rem;font-size:0.8rem;color:#666;text-transform:uppercase;font-weight:bold;">Requests</div>
      <div id="requests-list-container" class="friends-list" style="max-height:100px;"></div>
      <div style="margin-top:1rem;font-size:0.8rem;color:#666;text-transform:uppercase;font-weight:bold;">Online Friends</div>
      <div id="friends-list-container" class="friends-list"></div>
    </div>

    <script>
      function toggleAuth() {
        document.getElementById('login-card').classList.toggle('hidden');
        document.getElementById('signup-card').classList.toggle('hidden');
      }
      function toggleFriendsPanel() { document.getElementById('friends-panel').classList.toggle('hidden'); }
      function selectChar(char) {
        selectedChar = char;
        document.getElementById('char-messi').classList.toggle('selected', char === 'messi');
        document.getElementById('char-ronaldo').classList.toggle('selected', char === 'ronaldo');
      }
      selectChar('messi');
    </script>
  </body>
</html>
